<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- app layout and styling -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">

<!-- general components -->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<!-- icons -->
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">

<!-- helper elements -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">

<!-- app custom elements -->
<link rel="import" href="polymer-contacts-contact.html">
<link rel="import" href="polymer-contacts-detail.html">
<link rel="import" href="polymer-contacts-filters.html">
<link rel="import" href="polymer-contacts-theme-selector.html">

<dom-module id="polymer-contacts-app">
  <template>
    <style include="iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        display: block;
        font-family: sans-serif;
        --polymer-contacts-app-primary-color: #6200ee;
        --polymer-contacts-app-accent-color: #3700b3;
        --polymer-contacts-app-secondary-color: #03dac5;
        --polymer-contacts-app-background-color: #e1e1e1;
        --polymer-contacts-app-primary-color-font: #fff;
        --polymer-contacts-app-accent-color-font: #fff;
        --polymer-contacts-app-secondary-color-font: #fff;
        --paper-input-container-focus-color: var(--polymer-contacts-app-accent-color);
      }

      ::-webkit-scrollbar-track {
        border-radius: 10px;
        width: 0.3em;
      }

      ::-webkit-scrollbar {
        width: 0.3em;
      }

      ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background-color: #999;
      }

      app-header {
        color: var(--polymer-contacts-app-primary-color-font);
        background-color: var(--polymer-contacts-app-primary-color);
      }

      #body {
        display: block;
        height: 90vh;
        position: relative;
      }

      paper-fab {
        position: fixed;
        bottom: 5%;
        right: 5%;
        background-color: var(--polymer-contacts-app-accent-color);
        color: var(--polymer-contacts-app-accent-color-font);
      }

      .main-app-panel {
        @apply --layout-flex-12;
        position: relative;
      }

      .contact-detail-container {
        display: none;
        position: relative;
      }

      .mobileOn {
        display: block;
      }

      .mobileOff {
        display: none;
      }

      .loading {
        position: fixed;
        z-index: 1;
        background-color: #fff;
        opacity: 0.5;
        width: 100%;
        text-align: center;
        height: 100%;
        padding-top: 30%;
      }

      .empty-contacts {
        text-align: center;
        margin: 50px auto;
      }

      .contact-list {
        max-height: 80vh;
        overflow-y: scroll;
      }

      .hidden-contacts {
        text-align: center;
        margin: 20px;
        line-height: 25px;
        font-size: 0.9em;
        color: #666;
      }

      .hidden-contacts a {
        color: var(--polymer-contacts-app-accent-color);
      }

      @media screen and (min-width: 768px) {
        .main-app-panel {
          @apply --layout-flex-6;
        }

        .contact-detail-container {
          display: block;
        }

        .mobileOff {
          display: block;
        }

        #fab.mobileOff {
          display: none;
        }
      }

      @media screen and (min-width: 1024px) {
        #body {
          width: 1024px;
          margin: 0 auto;
        }

        .main-app-panel {
          margin: 20px;
        }

        #fab.mobileOff {
          display: block;
        }
      }

      @media screen and (min-width: 1440px) {
        #fab {
          right: 15%;
        }
      }
    </style>
    <app-header-layout>
      <app-header slot="header" fixed condenses effects="waterfall">
        <app-toolbar style="max-width: 1024px; margin: 0 auto">
          <div main-title>
            <iron-icon style="vertical-align: bottom;margin-right:10px;" icon="polymer"></iron-icon>Simple Contacts App
          </div>
          <paper-icon-button icon="image:color-lens" on-click="_openColorDialog"></paper-icon-button>
        </app-toolbar>
      </app-header>

      <!-- loading layer -->
      <template is="dom-if" if="[[loading]]">
        <div class="loading">
          <paper-spinner style="zoom:2.5" active="[[loading]]"></paper-spinner>
        </div>
      </template>

      <div id="body">
        <div class="layout horizontal">
          <!-- left app panel, with filters and contacts list -->
          <div id="contactListPanel" class="main-app-panel contact-list-container">
            <!-- filters -->
            <polymer-contacts-filters filters="{{filters}}" groups="{{groups}}" order="{{order}}"></polymer-contacts-filters>
            <!-- contacts list -->
            <div role="listbox" class="contact-list">
              <template is="dom-if" if="[[!contacts.length]]">
                <div class="empty-contacts">Your contacts list is empty :(</div>
              </template>
              <template id="contactListRepeat" is="dom-repeat" items="{{contacts}}" filter="_filterContactList" sort="_sortContactList"
                on-rendered-item-count-changed="_listRendered">
                <polymer-contacts-contact on-click="_selectContact" contact="{{item}}"></polymer-contacts-contact>
              </template>
              <template is="dom-if" if="{{hiddenContacts}}">
                <div class="hidden-contacts"><b>[[hiddenContacts]]</b> more contacts don't match the filters<br /><a
                    href="void(0)" on-click="_removeAllFilters">Remove all filters</a></div>
              </template>
            </div>
          </div>
          <!-- right app panel, with contact detail -->
          <div id="contactDetailPanel" class="main-app-panel contact-detail-container">
            <polymer-contacts-detail on-contact-delete="_deleteContact" on-close-clicked="_deselectContact"
              on-contact-saved="_saveContact" contact="{{selectedContact}}" groups="[[groups]]"></polymer-contacts-detail>
          </div>
        </div>
        <paper-fab elevation="3" id="fab" on-click="_newContact" icon="add"></paper-fab>
      </div>
    </app-header-layout>

    <!-- theme selector popup dialog -->
    <polymer-contacts-theme-selector id="themeSelector" theme="{{theme}}"></polymer-contacts-theme-selector>

    <!-- app helpers: toasts, ajax, etc -->
    <paper-toast id="toast"></paper-toast>
    <iron-ajax id="ajaxNewContact" on-response="_handleNewContactResponse" handle-as="json" url="https://randomuser.me/api/"></iron-ajax>
    <app-localstorage-document key="contacts" data="{{contacts}}"></app-localstorage-document>
    <app-localstorage-document key="theme" data="{{theme}}"></app-localstorage-document>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PolymerContactsApp extends Polymer.Element {
      static get is() { return 'polymer-contacts-app'; }
      static get properties() {
        return {
          loading: Boolean,
          groups: {
            type: Array,
            value: () => [
              { name: 'Favorite', status: false },
              { name: 'Family', status: false },
              { name: 'Friends', status: false }
            ]
          },
          contacts: {
            type: Array,
            value: () => []
          },
          selectedContact: {
            type: Object,
            value: undefined,
            observer: '_selectedContactChanged'
          },
          theme: {
            type: Object,
          },
          filters: {
            type: Object,
            value: () => ({})
          },
          order: {
            type: Object,
            value: () => ({
              property: "name.first",
              ascending: true
            })
          }
        };
      }
      static get observers() {
        return [
          '_renderList(filters.*,groups.*,order.*)',
          '_themeChanged(theme.*)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();
        this._loadDefaults();
      }

      _loadDefaults() {
        this.theme = {
          primaryColor: '#6200ee',
          accentColor: '#3700b3',
          secondaryColor: '#03dac5'
        };
      }

      _themeChanged(change) {
        function getContrastYIQ(hexcolor) {
          var r = parseInt(hexcolor.substr(1, 2), 16);
          var g = parseInt(hexcolor.substr(2, 2), 16);
          var b = parseInt(hexcolor.substr(4, 2), 16);
          var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
          return (yiq >= 128) ? '#000' : '#fff';
        }

        //Calculate the fonts based on contrast
        this.updateStyles({
          '--polymer-contacts-app-primary-color': this.theme.primaryColor,
          '--polymer-contacts-app-accent-color': this.theme.accentColor,
          '--polymer-contacts-app-secondary-color': this.theme.secondaryColor,
          '--polymer-contacts-app-primary-color-font': getContrastYIQ(this.theme.primaryColor),
          '--polymer-contacts-app-accent-color-font': getContrastYIQ(this.theme.accentColor),
          '--polymer-contacts-app-secondary-color-font': getContrastYIQ(this.theme.secondaryColor)
        });

      }

      _filterContactList(item) {

        if (this.filters.title && item.name.title.toLowerCase() != this.filters.title.toLowerCase()) {
          return false;
        }
        if (this.filters.name && (item.name.first.toLowerCase() + item.name.last.toLowerCase()).indexOf(this.filters.name.toLowerCase()) == -1) {
          return false;
        }
        if (this.groups && this.groups.some(fg => fg.status == true)) {
          if (!item.group) {
            return false;
          }
          const itemGroup = this.groups.find(fg => fg.name == item.group);
          if (!itemGroup || !itemGroup.status) {
            return false;
          }
        }

        return true;
      }
      _renderList() {
        this.$.contactListRepeat.render();
      }
      _sortContactList(a, b) {
        const levels = this.order.property.split('.');
        const getProp = obj => levels.reduce((acc, next) => acc && acc[next], obj);
        const pa = getProp(a), pb = getProp(b);
        return pa == pb ? 0 : this.order.ascending ? (pa > pb ? 1 : -1) : (pa > pb ? -1 : 1);
      }

      _selectContact(event) {
        this.selectedContact = event.target.contact;
      }
      _deselectContact() {
        this.selectedContact = undefined;
      }
      _saveContact(event) {
        const index = this.contacts.indexOf(this.selectedContact);
        if (index == -1) {
          //new contact
          this.push('contacts', event.detail.contact);
          this.selectedContact = event.detail.contact;
        } else {
          this.splice('contacts', index, 1, Object.assign({}, event.detail.contact));
          this.selectedContact = this.contacts[index];
        }
        this.showToast('Contact saved');
        this._deselectContact();
      }
      _selectedContactChanged(newValue) {
        if (newValue) {
          this.hideOnMobile([this.$.fab, this.$.contactListPanel]);
          this.showOnMobile([this.$.contactDetailPanel]);
        } else {
          this.hideOnMobile([this.$.contactDetailPanel]);
          this.showOnMobile([this.$.contactListPanel, this.$.fab]);
        }
      }
      showOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOn');
          elem.classList.remove('mobileOff');
        });
      }
      hideOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOff');
          elem.classList.remove('mobileOn');
        });
      }
      
      showToast(message) {
        this.$.toast.text = message;
        this.$.toast.show();
      }
      _newContact() {
        this.loading = true;
        //fetch a new user
        this.$.ajaxNewContact.generateRequest();
      }
      _handleNewContactResponse() {
        this.loading = false;
        // we assign a random group to the contact
        const group = {
          group: this.groups[Math.floor(Math.random() * this.groups.length)].name
        };
        this.selectedContact = Object.assign({}, this.$.ajaxNewContact.lastResponse.results[0], group);
      }
      _openColorDialog() {
        this.$.themeSelector.open();
      }
      _deleteContact() {
        const index = this.contacts.indexOf(this.selectedContact);
        if (index != -1) {
          this._deselectContact();
          this.splice('contacts', index, 1);
          this.showToast('Contact deleted');
        }
      }
      _listRendered(event) {
        this.hiddenContacts = this.contacts.length - event.currentTarget.renderedItemCount;
      }
      _removeAllFilters(event) {
        event.preventDefault();
        this.set('filters', Object.assign({}, this.defaultFilters));
        this.groups.forEach((g, index) => this.set(`groups.${index}.status`, false));
      }
    }

    window.customElements.define(PolymerContactsApp.is, PolymerContactsApp);
  </script>
</dom-module>