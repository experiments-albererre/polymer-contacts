<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- app layout and styling -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">

<!-- general components -->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<!-- icons -->
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">

<!-- helper elements -->
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">

<!-- app custom elements -->
<link rel="import" href="polymer-contacts-contact.html">
<link rel="import" href="polymer-contacts-detail.html">
<link rel="import" href="polymer-contacts-filters.html">
<link rel="import" href="polymer-contacts-theme-selector.html">

<dom-module id="polymer-contacts-app">
  <template>
    <style include="iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        display: block;
        font-family: sans-serif;
        --polymer-contacts-app-primary-color: #6200ee;
        --polymer-contacts-app-primary-color-variant: #3700b3;
        --polymer-contacts-app-secondary-color: #03dac5;
        --polymer-contacts-app-background-color: #e1e1e1;
        --polymer-contacts-app-primary-color-font: #fff;
        --polymer-contacts-app-primary-color-variant-font: #fff;
        --polymer-contacts-app-secondary-color-font: #fff;
      }

      app-header {
        color: var(--polymer-contacts-app-primary-color-font);
        background-color: var(--polymer-contacts-app-primary-color);
      }

      #body {
        display: block;
      }

      paper-fab {
        position: fixed;
        bottom: 5%;
        right: 5%;
        background-color: var(--polymer-contacts-app-primary-color-variant);
        color: var(--polymer-contacts-app-primary-color-variant-font);
      }

      .main-app-panel {
        @apply --layout-flex-12;
        position: relative;
      }

      .contact-detail-container {
        display: none;
        position: relative;
      }

      .mobileOn {
        display: block;
      }

      .mobileOff {
        display: none;
      }

      .loading {
        position: fixed;
        z-index: 1;
        background-color: #fff;
        opacity: 0.5;
        width: 100%;
        text-align: center;
        height: 100%;
        padding-top: 30%;
      }

      .empty-contacts {
        text-align: center;
        margin: 50px auto;
      }

      @media screen and (min-width: 768px) {
        .main-app-panel {
          @apply --layout-flex-6;
        }

        .contact-detail-container {
          display: block;
        }

        .mobileOff {
          display: block;
        }

        #fab.mobileOff {
          display: none;
        }
      }

      @media screen and (min-width: 1024px) {
        #body {
          width: 1024px;
          margin: 0 auto;
        }

        .main-app-panel {
          margin: 20px;
        }

        #fab.mobileOff {
          display: block;
        }
      }
    </style>
    <app-header-layout>
      <app-header slot="header" fixed condenses effects="waterfall">
        <app-toolbar style="max-width: 1024px; margin: 0 auto">
          <div main-title>
            <iron-icon style="vertical-align: bottom;margin-right:10px;" icon="polymer"></iron-icon>Simple Contacts App
          </div>
          <paper-icon-button icon="image:color-lens" on-click="_openColorDialog"></paper-icon-button>
        </app-toolbar>
      </app-header>

      <!-- loading layer -->
      <template is="dom-if" if="[[loading]]">
        <div class="loading">
          <paper-spinner style="zoom:2.5" active="[[loading]]"></paper-spinner>
        </div>
      </template>

      <div id="body">
        <div class="layout horizontal">
          <!-- left app panel, with filters and contacts list -->
          <div id="contactListPanel" class="main-app-panel contact-list-container">
            <!-- filters -->
            <polymer-contacts-filters filters="{{filters}}"></polymer-contacts-filters>
            <!-- contacts list -->
            <div role="listbox">
              <template is="dom-if" if="[[!contacts.length]]">
                <div class="empty-contacts">Your contacts list is empty :(</div>
              </template>
              <template id="contactListRepeat" is="dom-repeat" items="{{contacts}}" filter="_filterContactList">
                <polymer-contacts-contact on-click="_selectContact" contact="{{item}}"></polymer-contacts-contact>
              </template>
            </div>
          </div>
          <!-- right app panel, with contact detail -->
          <div id="contactDetailPanel" class="main-app-panel contact-detail-container">
            <polymer-contacts-detail on-contact-delete="_deleteContact" on-close-clicked="_deselectContact"
              on-contact-saved="_saveContact" contact="{{selectedContact}}" groups="[[filters.groups]]"></polymer-contacts-detail>
          </div>
        </div>
        <paper-fab elevation="3" id="fab" on-click="_newContact" icon="add"></paper-fab>
      </div>
    </app-header-layout>

    <!-- theme selector popup dialog -->
    <polymer-contacts-theme-selector id="themeSelector" theme="{{theme}}"></polymer-contacts-theme-selector>

    <!-- app helpers: toasts, ajax, etc -->
    <paper-toast id="toast"></paper-toast>
    <iron-ajax id="ajaxNewContact" on-response="handleNewContactResponse" handle-as="json" url="https://randomuser.me/api/"></iron-ajax>
    <app-localstorage-document key="contacts" data="{{contacts}}"></app-localstorage-document>
    <app-localstorage-document key="theme" data="{{theme}}"></app-localstorage-document>

  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PolymerContactsApp extends Polymer.Element {
      static get is() { return 'polymer-contacts-app'; }
      static get properties() {
        return {
          loading: {
            type: Boolean,
            value: false
          },
          groups: {
            type: Array,
            value: () => ['Favorite', 'Family', 'Friends']
          },
          contacts: {
            type: Array,
            value: () => []
          },
          selectedContact: {
            type: Object,
            value: undefined,
            observer: '_selectedContactChanged'
          },
          theme: {
            type: Object,
          },
          filters: {
            type: Object,
            value: () => ({})
          }
        };
      }
      static get observers() {
        return [
          '_filtersChanged(filters.*)',
          '_themeChanged(theme.*)'
        ]
      }

      connectedCallback() {
        super.connectedCallback();
        //we define the filters here because they depend on groups
        this.filters = {
          groups: this.groups.map(g => ({ 'name': g, 'status': false })),
          name: '',
          title: ''
        };
        this.theme = {
          primaryColor: '#6200ee',
          accentColor: '#3700b3',
          secondaryColor: '#03dac5'
        };
      }

      _themeChanged(change) {
        function getContrastYIQ(hexcolor) {
          var r = parseInt(hexcolor.substr(1, 2), 16);
          var g = parseInt(hexcolor.substr(2, 2), 16);
          var b = parseInt(hexcolor.substr(4, 2), 16);
          var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
          return (yiq >= 128) ? '#000' : '#fff';
        }

        //Calculate the fonts based on contrast
        this.updateStyles({
          '--polymer-contacts-app-primary-color': this.theme.primaryColor,
          '--polymer-contacts-app-primary-color-variant': this.theme.accentColor,
          '--polymer-contacts-app-secondary-color': this.theme.secondaryColor,
          '--polymer-contacts-app-primary-color-font': getContrastYIQ(this.theme.primaryColor),
          '--polymer-contacts-app-primary-color-variant-font': getContrastYIQ(this.theme.accentColor),
          '--polymer-contacts-app-secondary-color-font': getContrastYIQ(this.theme.secondaryColor)
        });

      }

      _filterContactList(item) {

        if (this.filters.title && item.name.title != this.filters.title) {
          return false;
        }
        if (this.filters.name && (item.name.first.toLowerCase() + item.name.last.toLowerCase()).indexOf(this.filters.name.toLowerCase()) == -1) {
          return false;
        }
        if (this.filters.groups && this.filters.groups.some(fg => fg.status == true) && (!item.group || this.filters.groups.find(fg => fg.name == item.group).status == false)) {
          return false;
        }

        return true;
      }
      _filtersChanged(change) {
        this.$.contactListRepeat.render();
      }

      _selectContact(event) {
        this.selectedContact = event.target.contact;
      }
      _deselectContact() {
        this.selectedContact = undefined;
      }
      _saveContact(event) {
        const index = this.contacts.indexOf(this.selectedContact);
        if (index == -1) {
          //new contact
          this.push('contacts', event.detail.contact);
          this.selectedContact = event.detail.contact;
        } else {
          this.splice('contacts', index, 1, Object.assign({}, event.detail.contact));
          this.selectedContact = this.contacts[index];
        }
        this.showToast('Contact saved');
        this._deselectContact();
      }
      _selectedContactChanged(newValue) {
        if (newValue) {
          this.showMobileContactDetail();
        } else {
          this.showMobileContactList();
        }
      }
      showOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOn');
          elem.classList.remove('mobileOff');
        });
      }
      hideOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOff');
          elem.classList.remove('mobileOn');
        });
      }
      showMobileContactList() {
        this.hideOnMobile([this.$.contactDetailPanel]);
        this.showOnMobile([this.$.contactListPanel, this.$.fab]);
      }
      showMobileContactDetail() {
        this.hideOnMobile([this.$.fab, this.$.contactListPanel]);
        this.showOnMobile([this.$.contactDetailPanel]);
      }
      showToast(message) {
        this.$.toast.text = message;
        this.$.toast.show();
      }
      _newContact() {
        this.loading = true;
        //fetch a new user
        this.$.ajaxNewContact.generateRequest();
      }
      handleNewContactResponse() {
        this.loading = false;
        // we assign a random group to the contact
        const group = {
          group: this.filters.groups[Math.floor(Math.random()*this.filters.groups.length)].name
        };
        this.selectedContact = Object.assign({}, this.$.ajaxNewContact.lastResponse.results[0], group);
      }
      _openColorDialog() {
        this.$.themeSelector.open();
      }
      _deleteContact() {
        const index = this.contacts.indexOf(this.selectedContact);
        if (index != -1) {
          this._deselectContact();
          this.splice('contacts', index, 1);
          this.showToast('Contact deleted');
        }
      }
    }

    window.customElements.define(PolymerContactsApp.is, PolymerContactsApp);
  </script>
</dom-module>