<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="polymer-contacts-contact.html">
<link rel="import" href="polymer-contacts-detail.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../../bower_components/web-animations-js/web-animations-next.min.html">

<dom-module id="polymer-contacts-app">
  <template>
    <style include="iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        display: block;
        font-family: sans-serif;
        --polymer-contacts-app-primary-color: #6200ee;
        --polymer-contacts-app-primary-color-variant: #3700b3;
        --polymer-contacts-app-secondary-color: #03dac5;
        --polymer-contacts-app-background-color: #e1e1e1;
        --polymer-contacts-app-primary-color-font: #fff;
        --polymer-contacts-app-primary-color-variant-font: #fff;
        --polymer-contacts-app-secondary-color-font: #fff;
      }

      app-header {
        color: var(--polymer-contacts-app-primary-color-font);
        background-color: var(--polymer-contacts-app-primary-color);
      }

      #body {
        display: block;
      }

      .filter-container {
        background: #eee;
        padding: 20px;
        margin: 20px;
      }

      paper-fab {
        position: fixed;
        bottom: 5%;
        right: 5%;
        background-color: var(--polymer-contacts-app-secondary-color);
        color: var(--polymer-contacts-app-secondary-color-font);
      }

      .main-app-panel {
        @apply --layout-flex-12;
        position: relative;
      }

      .contact-detail-container {
        display: none;
        position: relative;
      }

      .mobileOn {
        display: block;
      }

      .mobileOff {
        display: none;
      }

      .searcher-container {
        background: #eee;
        margin: 10px;
        height: 44px;
        border-radius: 22px;
        padding: 5px 9px 5px 5px;
        box-sizing: border-box;
      }

      .search-paper-input-wrapper {
        position: relative;
      }

      .search-paper-input-wrapper paper-input {
        position: absolute;
        top: -41px;
        width: 100%;
      }

      .loading {
        position: fixed;
        z-index: 1;
        background-color: #fff;
        opacity: 0.5;
        width: 100%;
        text-align: center;
        height: 100%;
        padding-top: 30%;
      }

      .empty-contacts {
        text-align: center;
        margin: 50px auto;
      }

      paper-button[raised] {
        background-color: var(--polymer-contacts-app-primary-color-variant);
        color: var(--polymer-contacts-app-primary-color-variant-font);
      }

      @media screen and (min-width: 768px) {
        .main-app-panel {
          @apply --layout-flex-6;
        }
        .contact-detail-container {
          display: block;
        }
        .mobileOff {
          display: block;
        }
        #fab.mobileOff{
          display: none;
        }
      }

      @media screen and (min-width: 1024px) {
        #body {
          width: 1024px;
          margin: 0 auto;
        }
        .main-app-panel {
          margin: 20px;
        }
        #fab.mobileOff{
          display: block;
        }
      }
    </style>
    <app-header-layout>
      <app-header slot="header" fixed condenses effects="waterfall">
        <app-toolbar style="max-width: 1024px; margin: 0 auto">
          <div main-title>
            <iron-icon style="vertical-align: bottom;margin-right:10px;" icon="polymer"></iron-icon>Simple Contacts App
          </div>
          <paper-icon-button icon="image:color-lens" on-click="_openColorDialog"></paper-icon-button>
        </app-toolbar>
      </app-header>
      <template is="dom-if" if="[[loading]]">
        <div class="loading">
          <paper-spinner style="zoom:2.5" active="[[loading]]"></paper-spinner>
        </div>
      </template>

      <div id="body">
        <div class="layout horizontal">
          <div id="contactListPanel" class="main-app-panel contact-list-container">
            <div class="searcher-container layout horizontal center">
              <paper-icon-button on-click="_removeFilters" data-filter="name" icon="cancel" disabled="[[!filters.name]]"></paper-icon-button>
              <div class="search-paper-input-wrapper flex-10">
                <paper-input value="{{filters.name}}"></paper-input>
              </div>
              <iron-icon class="flex" style="float:right; color: #666;" icon="search"></iron-icon>
            </div>
            <div class="filters-container" on-click="_toggleFilters">
              <paper-icon-button icon="expand-more" title="more info" style="float:right;"></paper-icon-button>
              <div style="padding:15px">Filter results</div>
            </div>
            <iron-collapse id="filters-collapse" style="width:100%;">
              <div class="filter-container">
                <paper-icon-button disabled="[[!filters.title]]" on-click="_removeFilters" data-filter="title" icon="block"></paper-icon-button>
                <input type="button" value="MR" on-click="setTitleFilter" />
                <input type="button" value="MISS" on-click="setTitleFilter" />
                <label>Other :<input type="text" placeholder="Filter by other titles..." value="{{filters.title::input}}"
                  /></label>
              </div>

              <div class="filter-container">
                <paper-icon-button disabled="[[!filters.groups]]" on-click="_removeFilters" data-filter="groups" icon="block"></paper-icon-button>

                <template is="dom-repeat" items="{{filters.groups}}">
                  <paper-checkbox on-change="groupFilterChanged" checked="[[item.status]]">[[item.name]]</paper-checkbox>
                </template>
              </div>
            </iron-collapse>
            <div role="listbox">
              <template is="dom-if" if="[[!contacts.length]]">
                <div class="empty-contacts">Your contacts list is empty :(</div>
              </template>
              <template id="contactListRepeat" is="dom-repeat" items="{{contacts}}" filter="_filterContactList">
                <polymer-contacts-contact on-click="_selectContact" contact="{{item}}"></polymer-contacts-contact>
              </template>
            </div>
          </div>
          <div id="contactDetailPanel" class="main-app-panel contact-detail-container">
            <polymer-contacts-detail contact="{{selectedContact}}"></polymer-contacts-detail>
          </div>
        </div>
      </div>
    </app-header-layout>

    <paper-dialog id="colorDialog">
      <h2>Custom theme</h2>
      <p>Choose your Primary, Accent and Secondary colors to theme the app.<br/> Text color will automatically change to
        contrast the background colors.
      </p>
      <div>
        Primary Color:
        <paper-swatch-picker color="{{theme.primaryColor}}"></paper-swatch-picker>
      </div>
      <div>
        Accent Color:
        <paper-swatch-picker color="{{theme.accentColor}}"></paper-swatch-picker>
      </div>
      <div>
        Secondary Color:
        <paper-swatch-picker color="{{theme.secondaryColor}}"></paper-swatch-picker>
      </div>


      <div class="buttons">
        <paper-button dialog-dismiss>Close</paper-button>
        <paper-button raised dialog-confirm autofocus>Apply</paper-button>
      </div>
    </paper-dialog>


    <paper-fab id="fab" on-click="_newContact" icon="add" data-filter="test"></paper-fab>
    <paper-toast id="toast"></paper-toast>
    <iron-ajax id="ajaxLoadContacts" params='{"results":10}' url="https://randomuser.me/api/" last-response="{{loadContactsResponse}}"
      handle-as="json" on-response="handleContactsResponse" debounce-duration="300"></iron-ajax>
    <iron-ajax id="ajaxNewContact" on-response="handleNewContactResponse" handle-as="json" url="https://randomuser.me/api/" last-response="{{newContactResponse}}"></iron-ajax>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PolymerContactsApp extends Polymer.Element {
      static get is() { return 'polymer-contacts-app'; }
      static get properties() {
        return {
          loading: {
            type: Boolean,
            value: false
          },
          groups: {
            type: Array,
            value: () => ['Favorite', 'Family', 'Friends']
          },
          contacts: {
            type: Array,
            value: () => []
          },
          selectedContact: {
            type: Object,
            value: undefined,
            observer: '_selectedContactChanged'
          },
          theme: {
            type: Object,
            value: undefined
          }
        };
      }
      static get observers() {
        return [
          '_filtersChanged(filters.*)',
          '_themeChanged(theme.*)'
        ]
      }
      constructor() {
        super();
        //we define the filters here because they depend on groups
        this.filters = {
          'groups': this.groups.map(g => ({ 'name': g, 'status': false })),
          'name': '',
          'title': ''
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this.loadContacts();
        this.$.contactDetailPanel.addEventListener('close-clicked', () => {
          this.selectedContact = undefined;
        });
        this.$.contactDetailPanel.addEventListener('contact-saved', e => {
          const index = this.contacts.indexOf(this.selectedContact);
          console.log(index);
          if (index == -1) {
            //new contact
            this.push('contacts', e.detail.contact);
            this.selectedContact = e.detail.contact;
          } else {
            this.splice('contacts', index, 1, Object.assign({}, e.detail.contact));
            this.selectedContact = this.contacts[index];
          }
          this.showToast('Changes made to the contact were saved');
        });
        this.theme = {
          'primaryColor': '#6200ee',
          'accentColor': '#3700b3',
          'secondaryColor': '#03dac5'
        };
      }

      _themeChanged(change) {

        function getContrastYIQ(hexcolor) {
          var r = parseInt(hexcolor.substr(1, 2), 16);
          var g = parseInt(hexcolor.substr(2, 2), 16);
          var b = parseInt(hexcolor.substr(4, 2), 16);
          var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
          return (yiq >= 128) ? '#000' : '#fff';
        }

        //Calculate the fonts based on contrast
        this.updateStyles({
          '--polymer-contacts-app-primary-color': this.theme.primaryColor,
          '--polymer-contacts-app-primary-color-variant': this.theme.accentColor,
          '--polymer-contacts-app-secondary-color': this.theme.secondaryColor,
          '--polymer-contacts-app-primary-color-font': getContrastYIQ(this.theme.primaryColor),
          '--polymer-contacts-app-primary-color-variant-font': getContrastYIQ(this.theme.accentColor),
          '--polymer-contacts-app-secondary-color-font': getContrastYIQ(this.theme.secondaryColor)
        });

      }

      loadContacts() {
        //show loading
        this.loading = true;
        //fetch
        setTimeout(() => {
          this.$.ajaxLoadContacts.generateRequest();
        }, 1000);
      }

      handleContactsResponse() {
        this.loading = false;
        this.loadContactsResponse.results.forEach(c => {
          //we fake a random group into the contact
          this.push('contacts', Object.assign({}, c, { group: this.groups[Math.floor(Math.random() * this.groups.length)] }));
        });
      }
      setTitleFilter(event) {
        this.set('filters.title', event.target.value.toLowerCase());
      }
      _filterContactList(item) {

        if (this.filters.title && item.name.title != this.filters.title) {
          return false;
        }
        if (this.filters.name && (item.name.first.toLowerCase() + item.name.last.toLowerCase()).indexOf(this.filters.name.toLowerCase()) == -1) {
          return false;
        }
        //loop the groups to filter out
        //Object.keys(this.filters.group).forEach(g => this.filters.group[g] && (valid = item.group == g));
        if (this.filters.groups.some(fg => fg.status == true) && (!item.group || this.filters.groups.find(fg => fg.name == item.group).status == false)) {
          return false;
        }

        return true;
      }
      _filtersChanged(change) {
        this.$.contactListRepeat.render();
      }
      groupFilterChanged(event) {
        event.model.set('item.status', event.target.checked);
      }
      _removeFilters(event) {
        const filter = event.target.dataset["filter"];
        if (filter == 'groups') {
          this.filters.groups.forEach((fg, index) => {
            this.set(`filters.groups.${index}.status`, false);
          });
        } else {
          this.set(`filters.${filter}`, '');
        }
      }
      _toggleFilters() {
        this.$['filters-collapse'].toggle();
      }
      _selectContact(e) {
        console.log(e.target.contact);
        this.selectedContact = e.target.contact;
      }
      _selectedContactChanged(newValue) {
        if (newValue) {
          this.showMobileContactDetail();
        } else {
          this.showMobileContactList();
        }
      }
      showOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOn');
          elem.classList.remove('mobileOff');
        });
      }
      hideOnMobile(elems) {
        elems.forEach(elem => {
          elem.classList.add('mobileOff');
          elem.classList.remove('mobileOn');
        });
      }
      showMobileContactList() {
        this.hideOnMobile([this.$.contactDetailPanel]);
        this.showOnMobile([this.$.contactListPanel,this.$.fab]);
      }
      showMobileContactDetail() {
        this.hideOnMobile([this.$.fab,this.$.contactListPanel]);
        this.showOnMobile([this.$.contactDetailPanel]);
      }
      showToast(message) {
        this.$.toast.text = message;
        this.$.toast.show();
      }
      _newContact() {
        this.loading = true;
        //fetch a new user
        this.$.ajaxNewContact.generateRequest();
      }
      handleNewContactResponse() {
        this.loading = false;
        this.selectedContact = Object.assign({}, this.newContactResponse.results[0]);
      }
      _openColorDialog() {
        this.$.colorDialog.open();
      }
    }

    window.customElements.define(PolymerContactsApp.is, PolymerContactsApp);
  </script>
</dom-module>